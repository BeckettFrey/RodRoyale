# Rod Royale API Test Suite

Pending comprehensive end-to-end testing for the Rod Royale fishing app backend API.

## Overview

This test suite provides complete coverage of all API endpoints and features:
- **Authentication & Authorization** - User registration, login, JWT tokens
- **User Management** - Profiles, relationships, account deletion
- **Catch Management** - CRUD operations, image uploads, feed generation
- **Pin Management** - Location pins with visibility controls
- **Leaderboards** - Statistics and rankings
- **Social Features** - Following, feed filtering, privacy
- **Integration Tests** - Cross-endpoint workflows and data consistency

## Test Structure

```
tests/
├── conftest.py              # Test configuration and fixtures
├── test_auth.py             # Authentication endpoint tests
├── test_users.py            # User management tests
├── test_catches.py          # Catch CRUD and validation tests
├── test_pins.py             # Pin management and visibility tests
├── test_leaderboards.py     # Leaderboard and statistics tests
├── test_integration.py      # Cross-feature integration tests
├── run_tests.py             # Test runner utility
└── README.md               # This file
```

## Running Tests

### Prerequisites

1. Install test dependencies:
```bash
pip install -r requirements-dev.txt
```

2. Ensure MongoDB is running and accessible
3. Set environment variables in `.env` file

### Basic Test Execution

```bash
# Run all tests
python -m pytest tests/ -v

# Run specific test file
python -m pytest tests/test_auth.py -v

# Run tests with coverage report
python -m pytest tests/ --cov=. --cov-report=html --cov-report=term-missing

# Run using the test runner utility
python tests/run_tests.py all
python tests/run_tests.py coverage
python tests/run_tests.py test_auth.py
```

### Test Categories

**Authentication Tests (`test_auth.py`)**
- User registration and validation
- Login/logout flows
- JWT token creation and validation
- Password hashing and verification
- Protected endpoint access

**User Management Tests (`test_users.py`)**
- User profile CRUD operations
- Follow/unfollow relationships
- User search functionality
- Account deletion with cascade cleanup
- Privacy and permission controls

**Catch Management Tests (`test_catches.py`)**
- Catch creation and validation
- Image upload integration
- Feed generation and filtering
- Catch updates and deletion
- Location and species validation

**Pin Management Tests (`test_pins.py`)**
- Pin creation and automatic generation
- Visibility controls (public/private)
- Location validation
- User permission checks
- Pin lifecycle management

**Leaderboard Tests (`test_leaderboards.py`)**
- User statistics calculations
- Global and species-specific rankings
- Following-based comparisons
- Real-time stat updates
- Sorting and ranking logic

**Integration Tests (`test_integration.py`)**
- End-to-end user workflows
- Cross-endpoint data consistency
- Permission and security integration
- Cascade deletion testing
- Social feature interactions

## Test Configuration

### Fixtures (`conftest.py`)

The test suite uses pytest fixtures for consistent test data:

- `test_db` - Clean test database for each test
- `test_user` / `test_user_2` - Sample user accounts
- `auth_headers` - Authentication headers
- `test_catch` / `test_pin` - Sample data objects
- `sample_*_data` - Template data for creation tests

### Database Isolation

Each test uses a separate test database (`rod_royale_db_test`) that is cleaned before and after each test to ensure isolation.

### Authentication Testing

Tests use JWT tokens generated by the `AuthUtils` class to simulate authenticated requests.

## API Coverage

### Authentication Endpoints
- `POST /api/v1/auth/register` - User registration
- `POST /api/v1/auth/login` - User login
- `GET /api/v1/auth/me` - Get current user
- `POST /api/v1/auth/refresh` - Token refresh
- `POST /api/v1/auth/logout` - User logout

### User Management Endpoints
- `POST /api/v1/users/` - Create user
- `GET /api/v1/users/search` - Search users
- `GET /api/v1/users/{id}` - Get user by ID
- `GET /api/v1/users/me` - Get current user
- `PUT /api/v1/users/{id}` - Update user
- `POST /api/v1/users/{id}/follow/{target_id}` - Follow user
- `DELETE /api/v1/users/{id}/follow/{target_id}` - Unfollow user
- `GET /api/v1/users/{id}/followers` - Get followers
- `GET /api/v1/users/{id}/following` - Get following
- `DELETE /api/v1/users/me` - Delete account

### Catch Management Endpoints
- `POST /api/v1/catches/` - Create catch
- `POST /api/v1/catches/upload-with-image` - Create with image
- `GET /api/v1/catches/feed` - Get feed
- `GET /api/v1/catches/me` - Get my catches
- `GET /api/v1/catches/{id}` - Get catch by ID
- `GET /api/v1/catches/users/{id}/catches` - Get user catches
- `PUT /api/v1/catches/{id}` - Update catch
- `DELETE /api/v1/catches/{id}` - Delete catch

### Pin Management Endpoints
- `POST /api/v1/pins/` - Create pin
- `GET /api/v1/pins/` - Get pins
- `PUT /api/v1/pins/{id}` - Update pin
- `DELETE /api/v1/pins/{id}` - Delete pin

### Leaderboard Endpoints
- `GET /api/v1/leaderboard/my-stats` - Get user stats
- `GET /api/v1/leaderboard/following-comparison` - Compare with following
- `GET /api/v1/leaderboard/global` - Global leaderboard
- `GET /api/v1/leaderboard/species/{species}` - Species leaderboard

## Test Data Management

### Sample Data

Tests use realistic sample data:
- Users with proper email formats and secure passwords
- Catches with valid species, weights, and GPS coordinates
- Pins with proper visibility settings
- Relationships between users for social features

### Data Validation

Tests verify both successful operations and proper error handling:
- Invalid data format rejection
- Authentication requirement enforcement
- Permission boundary testing
- Database constraint validation

## Continuous Integration

This test suite is designed for CI/CD pipelines:
- Isolated test database prevents conflicts
- Comprehensive coverage ensures stability
- Clear success/failure reporting
- Performance timing for optimization

## Debugging

### Common Issues

1. **Import Errors**: Ensure all dependencies are installed
2. **Database Connection**: Verify MongoDB is running and accessible
3. **Authentication Failures**: Check JWT secret configuration
4. **Async Test Issues**: Ensure proper pytest-asyncio setup

### Debugging Tips

```bash
# Run tests with detailed output
python -m pytest tests/ -v -s

# Run single test with debug info
python -m pytest tests/test_auth.py::TestAuthEndpoints::test_login_success -v -s

# Generate coverage report
python -m pytest tests/ --cov=. --cov-report=html
# View report at htmlcov/index.html
```

### Common Test Issues

1. **Database Connection Error** (`'NoneType' object has no attribute 'users'`)
   - **Cause**: MongoDB is not running or not accessible
   - **Solution**: Start MongoDB service: `brew services start mongodb/brew/mongodb-community` (macOS) or ensure MongoDB is running on your system
   - **Check**: Verify connection with `mongosh` or your MongoDB client

2. **Import Errors**: Ensure all dependencies are installed
   - Run: `pip install pytest pytest-asyncio httpx pytest-cov`

3. **HTTP Version Compatibility** (`Client.__init__() got an unexpected keyword argument 'app'`)
   - **Cause**: Version mismatch between starlette and httpx
   - **Solution**: Use compatible versions: `pip install "httpx==0.25.0"`

4. **Authentication Failures**: Check JWT secret configuration in `.env`

5. **Async Test Issues**: Ensure proper pytest-asyncio setup with `pytest.ini`

## Contributing

When adding new features:

1. Add corresponding test cases
2. Update fixtures if needed
3. Ensure integration tests cover new workflows
4. Update this README with new endpoint coverage
5. Verify all tests pass before submitting
